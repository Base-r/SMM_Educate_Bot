import time
import fnmatch
from aiogram import types
from aiogram.filters.chat_member_updated import \
    ChatMemberUpdatedFilter, MEMBER, KICKED, IS_NOT_MEMBER, ADMINISTRATOR
from aiogram.types import ChatMemberUpdated, ChatMember
from finite_state_machine import *

admin_router = Router()
formattime = '%d.%m.%Y %H:%M'


class Addlesson(StatesGroup):
    # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    urok = State()
    subt = State()
    rename = State()
    v1urok = State()
    v2index = State()
    v3images = State()
    v4text = State()


class AddTariff(StatesGroup):
    rename = State()
    price = State()


@admin_router.message(Command(commands=["admin"]))
@admin_router.message(F.text.contains('ü•π'))
async def cmd_test1(message: Message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    username = message.from_user.username
    if get_admin(chat_id):
        await message.answer(
            text=f"–ü—Ä–∏–≤–µ—Ç! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ –º–µ–Ω—è –≤ "
                 f'{message.chat.type} "{message.chat.title}" '
                 f"–∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. ID —á–∞—Ç–∞: {message.chat.id}")
        add_admin(user_id, username)
    if message.from_user.id in adminchat_id or message.chat.id in adminchat_id:
        add_admin(user_id, username)


@admin_router.message(Command(commands=["renameLesson"]))
@admin_router.message(F.text.contains("üòÉ"))
async def add_less(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å:",
            reply_markup=keybrd_lesson(message.message_id, 'rename'))


#        await state.update_data(podr="")
@admin_router.callback_query(Lesson.filter(F.status == "rename"))
async def less_rename(call: CallbackQuery, callback_data: Lesson, state: FSMContext):
    print('rename', callback_data.status)
    await call.message.edit_text(text=f'index —É—Ä–æ–∫–∞ {callback_data.id_} –≤–≤–æ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ')
    await state.set_state(Addlesson.rename)
    await state.update_data(id=callback_data.id_)
    await state.update_data(msgid=call.message.message_id)


@admin_router.message(Addlesson.rename)
async def add_etap(message: Message, state: FSMContext) -> None:
    data = await state.get_data()
    update_lesson(int(data['id']), "–£—Ä–æ–∫ " + data['id'], message.text)
    await message.answer(
        "–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ")
    await state.clear()


@admin_router.message(Command(commands=["update_tariff"]))
@admin_router.message(F.text.contains("ü§ì"))
async def add_tariff(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–∞—Ä–∏—Ñ–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å:", reply_markup=keybrd_tarif(message.message_id, 'rename'))


#        await state.update_data(podr="")


@admin_router.callback_query(Tariff.filter(F.status == "rename"))
async def tariff_rename(call: CallbackQuery, callback_data: Tariff, state: FSMContext):
    print('rename', callback_data.status)
    await call.message.edit_text(text=f'–¢–∞—Ä–∏—Ñ {callback_data.id_} –≤–≤–æ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ')
    await state.set_state(AddTariff.rename)
    await state.update_data(id=callback_data.id_)
    await state.update_data(msgid=call.message.message_id)


@admin_router.message(AddTariff.rename)
async def tariff_new_price(message: Message, state: FSMContext) -> None:
    print('price')
    await message.answer(text=f'–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ\\. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É: ')
    await state.set_state(AddTariff.price)
    await state.update_data(text=message.text)
    

@admin_router.message(AddTariff.price)
async def update_tariff(message: Message, state: FSMContext) -> None:
    data = await state.get_data()
    
    upadate_tariff(int(data['id']), new_name=data['text'], new_price=float(message.text.replace('.',',')))
    await message.answer("–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
    await state.clear()

# –¥–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫ –∫–æ–º–∞–Ω–¥–æ–π –≤ –±–æ—Ç–µ /addU
# –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —Å–º–∞–π–ª–∏–∫
@admin_router.message(Command(commands=["addU"]))
@admin_router.message(F.text.contains(":)"))
async def add_urok(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞:")
        await state.set_state(Addlesson.urok)
            #reply_markup=keybrd_lesson(message.message_id, 'addU'))
@admin_router.message(Addlesson.urok)
async def add_urok1(message: types.Message, state: FSMContext) -> None:
    await state.update_data(title=message.text)
    await state.set_state(Addlesson.subt)
    await message.answer(text=f'–æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞')
@admin_router.message(Addlesson.subt)
async def add_urok2(message: types.Message, state: FSMContext) -> None:
    data = await state.get_data()
    await state.clear()
    lesson1_id = add_lesson(data['title'], message.text)
    await message.answer(text=f'–¥–æ–±–∞–≤–∏–ª')

# –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞
@admin_router.message(Command(commands=["adde"]))
@admin_router.message(F.text.contains("üòÅ"))
async def add_etap(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —É—Ä–æ–∫–æ–≤, –∫—É–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —ç—Ç–∞–ø —É—Ä–æ–∫–∞:",
            reply_markup=keybrd_lesson(message.message_id, 'addE'))

#        await state.set_state(Addlesson.v1urok)
@admin_router.callback_query(Lesson.filter(F.status == "addE"))
async def adde_1(call: CallbackQuery, callback_data: Lesson, state: FSMContext):
    await state.set_state(Addlesson.v2index)
    await state.update_data(id=callback_data.id_)
    await state.update_data(msgid=call.message.message_id)
    await call.message.edit_text(text=f'–£—Ä–æ–∫ {callback_data.id_} —Ç–µ–ø–µ—Ä—å –Ω–∞–¥–æ —É–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —ç—Ç–∞–ø–∞')


@admin_router.message(Addlesson.v2index)
async def photo_handler(message: types.Message, state: FSMContext) -> None:
    await state.update_data(index=message.text)
    await state.set_state(Addlesson.v3images)
    await message.answer(text=f'–∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–æ—Ç–æ')


@admin_router.message(F.content_type.in_({'photo'}), Addlesson.v3images)  # , 'sticker'
async def photo_handler(message: types.Message, state: FSMContext) -> None:
    nado = False
    if message.content_type == types.ContentType.PHOTO:
        key = message.photo[-1].file_id
        # file = await bot.get_file(message.photo[-1].file_id)
        # downloaded_file = await bot.download_file(file.file_path)
        # with open('_temp/' + '22.jpg', 'wb') as f:
        #    f.write(downloaded_file.getvalue())
        images = message.photo[-1].file_id + '|' + message.photo[-2].file_id + '|' + message.photo[-3].file_id
        time.sleep(1)
        await state.set_state(Addlesson.v4text)
        await state.update_data(images=images)
        await message.answer(text=f'–∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ç–µ–∫—Å—Ç')


@admin_router.message(Addlesson.v4text)
async def photo_handler4(message: types.Message, state: FSMContext) -> None:
    data = await state.get_data()
    add_stage(—É—Ä–æ–∫_id=data['id'],
              index=data['index'],
              images=data['images'],
              lesson_text=message.text,
              lesson_speech=''
              )
    await state.clear()
    await message.answer(text=f'–≥–æ—Ç–æ–≤–æ, –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∂–º–∏ üòÅ')



@admin_router.message(Command(commands=["deletestage"]))
@admin_router.message(F.text.contains(":p"))
async def delete_stage(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–≤—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø:",
            reply_markup=keybrd_lesson(message.message_id, 'deletestage'))
@admin_router.callback_query(Lesson.filter(F.status == "deletestage"))
async def delete_stage1(call: CallbackQuery, callback_data: Lesson, state: FSMContext):
    print(callback_data.status)
    keybrd = keybrd_stage(int(callback_data.id_), call.message.message_id, 'deletestage1')
    if keybrd:
        await call.message.edit_text(
            "–≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å:",
            reply_markup=keybrd)
    else:
        await call.message.edit_text(
            "–Ω–µ—Ç—É —ç—Ç–∞–ø–æ–≤")
@admin_router.callback_query(Lesstage.filter(F.status == "deletestage1"))
async def delete_stage2(call: CallbackQuery, callback_data: Lesstage, state: FSMContext):
    print(callback_data.status)
    delete_lstage(int(callback_data.id_lesson), int(callback_data.id_stage))
    await call.message.edit_text(text=f'—ç—Ç–∞–ø {callback_data.id_stage} —É–¥–∞–ª–µ–Ω')

@admin_router.message(Command(commands=["editlesson"]))
@admin_router.message(F.text.contains(";)"))
async def edit_less(message: Message) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:",
            reply_markup=keybrd_lesson(message.message_id, 'editlesson'))

@admin_router.callback_query(Lesson.filter(F.status == "editlesson"))
async def edit_less1(call: CallbackQuery, callback_data: Lesson, state: FSMContext):
    print(callback_data.status)
    await call.message.edit_text(text=f'–£—Ä–æ–∫ {callback_data.id_} —É–¥–∞–ª–µ–Ω')


@admin_router.message(Command(commands=["deletelesson"]))
@admin_router.message(F.text.contains("ü•µ"))
async def delete_less(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await message.answer(
            "–≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å:",
            reply_markup=keybrd_lesson(message.message_id, 'deletelesson'))


@admin_router.callback_query(Lesson.filter(F.status == "deletelesson"))
async def delete_less1(call: CallbackQuery, callback_data: Lesson, state: FSMContext):
    print(callback_data.status)
    delete_lesson(int(callback_data.id_))
    await call.message.edit_text(text=f'–£—Ä–æ–∫ {callback_data.id_} —É–¥–∞–ª–µ–Ω')

@admin_router.message(Command(commands=["getlesson"]))
@admin_router.message(F.text.contains(":/"))
async def get_less(message: Message, state: FSMContext) -> None:
    if get_admin(message.from_user.id) or message.from_user.id in adminchat_id:
        await otpravka(message)
@admin_router.my_chat_member(
    ChatMemberUpdatedFilter(member_status_changed=KICKED)
)
async def user_blocked_bot(event: ChatMemberUpdated):
    key = event.from_user.id
    pole = 'kick'
    value = str(dt.today().strftime(formattime))


@admin_router.my_chat_member(
    ChatMemberUpdatedFilter(member_status_changed=MEMBER)
)
async def user_unblocked_bot(event: ChatMemberUpdated):
    key = event.chat.id
    pole = event.new_chat_member.status
    value = event.from_user.id
    # db.update_one(key=event.from_user.id, pole='newmember', value=str(dt.today().strftime(formattime)))


@admin_router.chat_member(ChatMember)
async def user_unblocked_bot(event: ChatMember):
    key = event.chat.id
    pole = event.status
    value = event.user.id
    # db.update_one(key=event.from_user.id, pole='newmember', value=str(dt.today().strftime(formattime)))
